<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
    <!-- Font Awesome CSS -->
    <link
      href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link href="owner.css" rel="stylesheet" />
    <title>세탁센터 | 사장님</title>
  </head>

  <body>
    <div id="wrap">
      <header>
          <nav>
              <ul class="nav_items">
                  <li><a onclick="window.location.href='/', style='cursor: pointer';"><strong><button>로그아웃</button></strong></a></li>
              </ul>
          </nav>
      </header>
  </div>
    <div
      class="jumbotron bg-sparta text-white text-center mytitle"
      onclick="window.location.href='/api/laundries/owner/'"
    >
      <h1 class="font-weight-bold">스파르타 세탁소</h1>
    </div>

    <span id="ownerInfo">
      <div class="container" style="margin-top: 50px; text-align: center; margin-bottom: 20px">
        <h4 class="col">오늘도 열심히 세탁해볼까요?</h4>
        <h4 class="col" style="margin-top:30px" id="shopName"></h4>
      </div>
      
      </div>
      <div class="container" style="margin-top: 50px">
        <h4 class="col" style="text-align: center; margin-bottom: 20px">
          현재 보유 포인트
        </h4>
        <h4 class="col" style="text-align: center; margin-bottom: 50px" id="ownerPoint"></h4>
      </div>
    </span>

    <div class="wrap">
      <div class="row d-flex justify-content-around">
        <div class="col-3 pr-2">
          <button
            onclick="open_laundry_list()"
            type="button"
            class="btn btn-sparta btn-block"
            style="margin-right: 15px"
          >
            세탁물 조회
          </button>
        </div>
        <div class="col-3 pl-2">
          <button
            onclick="open_myWork_list()"
            type="button"
            class="btn btn-outline-sparta btn-block"
          >
            작업물 조회
          </button>
        </div>
        <div class="col-3 pl-2">
          <button
            onclick="open_review_list()"
            type="button"
            class="btn btn-outline-sparta btn-block"
          >
            리뷰 조회
          </button>
        </div>
        <div class="col-3 pl-2">
          <button
            onclick="window.location.href='/ownerChat.html'"
            type="button"
            class="btn btn-outline-sparta btn-block"
          >
            사장님 채팅방
          </button>
        </div>
      </div>
    </div>
<!-------------------------------------세탁물 조회------------------------------------------->
    <div class="laundry_list" id="viewLaundries">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <table class="table table-bordered" id="laundry_list">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">세탁물</th>
                  <th scope="col">요청사항</th>
                  <th scope="col">사진</th>
                  <th scope="col">상태</th>
                  <th scope="col">생성일</th>
                  <th scope="col">메뉴</th>
                </tr>
              </thead>
              
            </table>
          </div>
        </div>
      </div>
      <!-- 닫기 버튼-->
      <div class="wrap">
        <div class="row d-flex justify-content-around">
          <div class="col-3 pr-2">
            
            <ul class="pagination justify-content-center mt-3">
              <li class="page-item"><a class="page-link" href="#">Previous</a></li>
              <li class="page-item"><a id="page-1" class="page-link" href="#">1</a></li>
              <li class="page-item"><a id="page-2" class="page-link" href="#">2</a></li>
              <li class="page-item"><a id="page-3" class="page-link" href="#">3</a></li>
              <li class="page-item"><a class="page-link" href="#">Next</a></li>
          </ul>

            <button
              onclick="close_laundry_list()"
              type="button"
              class="btn btn-sparta btn-block"
              style="margin-right: 15px"
            >
              닫기
            </button>
          </div>
        </div>
      </div>
    </div>

<!-------------------------------------작업물 조회------------------------------------------->
    <div class="laundry_list" id="viewWorkLists">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <table class="table table-bordered" id="viewWorks">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">세탁물</th>
                <th scope="col">요청사항</th>
                <th scope="col">사진</th>
                <th scope="col">상태</th>
                <th scope="col">생성일</th>
                <th scope="col">세탁물 배송상황</th>
                <th scope="col">메뉴</th>
              </tr>
            </thead>
            

          </table>
        </div>
      </div>
    </div>
    <!-- 닫기 버튼-->
    <div class="wrap">
      <div class="row d-flex justify-content-around">
        <div class="col-3 pr-2">
          <button
            onclick="close_myWork_list()"
            type="button"
            class="btn btn-sparta btn-block"
            style="margin-right: 15px"
          >
            닫기
          </button>
        </div>
      </div>
    </div>
  </div>

<!-------------------------------------리뷰 조회------------------------------------------->
  <div class="laundry_list" id="viewReview">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <table class="table table-bordered" id="viewMyReview">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">세탁물</th>
                <th scope="col">요청사항</th>
                <th scope="col">사진</th>
                <th scope="col">생성일</th>
                <th scope="col">리뷰</th>
              </tr>
            </thead>


          </table>
        </div>
      </div>
    </div>
    <!-- 닫기 버튼-->
    <div class="wrap">
      <div class="row d-flex justify-content-around">
        <div class="col-3 pr-2">
          <button
            onclick="close_review_list()"
            type="button"
            class="btn btn-sparta btn-block"
            style="margin-right: 15px"
          >
            닫기
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modalalert-->
    <div
      class="modal text-left"
      id="alertModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="alertModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="alertModalLabel">알림</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="alertText"></div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-sparta btn-confirm"
              data-dismiss="modal"
            >
              확인
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.5.1.js"
      integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
      integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
    <script src="/api.js"></script>
  
    <script>
    $(document).ready(function () {
      getSelf(function (owner) {
        let shopName = owner.shopName
        let ownerPoint = owner.ownerPoint
        $('#shopName').append(shopName);
        $('#ownerPoint').append(ownerPoint);
      })
    })

      function open_laundry_list() {
        $('#viewWorkLists').hide();
        $('#viewReview').hide();
        laundry_list()
        $('#viewLaundries').show()
      }

      function close_laundry_list() {
        $('#viewLaundries').hide();
      }

      function open_myWork_list() {
        $('#viewLaundries').hide();
        $('#viewReview').hide();
        myWork_list()
        $('#viewWorkLists').show()
      }

      function close_myWork_list() {
        $('#viewWorkLists').hide();
      }

      function open_review_list() {
        $('#viewLaundries').hide();
        $('#viewWorkLists').hide();
        myReview_list()
        $('#viewReview').show()
      }

      function close_review_list() {
        $('#viewReview').hide();
      }

//  페이지 시작 시 작동 --------------------
$(document).ready(() => {
    let pagenumber = localStorage.getItem('pagenumber')
    if (!pagenumber) {
        laundry_list(1)
    } else {
        laundry_list(parseInt(pagenumber))
    }
    document.getElementById('page-1').addEventListener('click', () => {
        localStorage.setItem('pagenumber', 1)
        laundry_list(1)
    })

    document.getElementById('page-2').addEventListener('click', () => {
        localStorage.setItem('pagenumber', 2)
        laundry_list(2)
    })

    document.getElementById('page-3').addEventListener('click', () => {
        localStorage.setItem('pagenumber', 3)
        laundry_list(3)
    })
  })

      //세탁물 조회
      function laundry_list(parameter) {
        $.ajax({
          type: 'GET',
          url: `/api/owner/laundry_list?pageNum=${parameter}`,
          data: {},
          headers: {
          authorization: `Bearer ${localStorage.getItem('token')}`,
          },
          success: function (response) {
            let rows = response['laundries'];

            $('#laundry_list').empty()

            for (let i = 0; i < rows.length; i++) {
              let laundryId = rows[i]['laundryId'];
              let userId = rows[i]['userId']
              let laundryName = rows[i]['laundryName'];
              let request = rows[i]['request'];
              let img = rows[i]['img'];
              let status = rows[i]['status'];
              let createdAt = rows[i]['createdAt'];

              let temp_html = `<tbody>
                                <tr>
                                  <th scope="row">${laundryId}</th>
                                  <td>${laundryName}</td>
                                  <td>${request}</td>
                                  <td>${img}</td>
                                  <td>${status}</td>
                                  <td>${createdAt}</td>
                                  <td>
                                    <button onclick="(${userId})" type="button" class="btn btn-success"><i class="fa fa-user"></i></button>
                                    <button onclick="addToMyWork(${laundryId})" type="button" class="btn btn-dark"><i class="fa fa-truck"></i></button>
                                  </td>
                                </tr>
                              </tbody>`;
              $('#laundry_list').append(temp_html);
            }
          },
        });
      }

      //세탁물 담기
      // 서버에서 보낸 owner정보 받아서 shopName 같이 getLaundry로 넘기기
      function addToMyWork(laundryId) {
        $.ajax({
          type: 'POST',
          url: `/api/owner/laundry_list/${laundryId}/add`,
          data: {},
          headers: {
          authorization: `Bearer ${localStorage.getItem('token')}`,
          },
          success: function (response) {
            let shopName = response['shopName']
            getLaundry(shopName, laundryId)
            customAlert('선택하신 세탁물을 작업 목록에 저장하였습니다.', function () {
              window.location.reload();
            });
          },
          error: function (error) {
            customAlert(error.responseJSON.errorMessage);
          }
        });
      }

      //작업물 조회
      function myWork_list() {
        $.ajax({
          type: 'GET',
          url: '/api/owner/ownerWorkList',
          data: {},
          headers: {
          authorization: `Bearer ${localStorage.getItem('token')}`,
          },
          success: function (response) {
            let rows = response['getMyWork'];

            $('#viewWorks').empty()

            for (let i = 0; i < rows.length; i++) {
              let laundryId = rows[i]['laundryId'];
              let userId = rows[i]['userId']
              let laundryName = rows[i]['laundryName'];
              let request = rows[i]['request'];
              let img = rows[i]['img'];
              let status = rows[i]['status'];
              let createdAt = rows[i]['createdAt'];
              
              let temp_html = `<tbody>
                                <tr>
                                  <th scope="row">${laundryId}</th>
                                  <td>${laundryName}</td>
                                  <td>${request}</td>
                                  <td>${img}</td>
                                  <td>${status}</td>
                                  <td>${createdAt}</td>
                                  <td>
                                    <form>
                                      <select onchange="updateStatus(${laundryId})" id="select_status_${laundryId}">
                                        <option>-- 업데이트 --</option>
                                        <optgroup label="세탁물 배송상태">
                                          <option>수거 완료</option>
                                          <option>배송 중</option>
                                          <option>배송 완료</option>                                
                                        </optgroup>
                                      </select>
                                    </form>
                                  </td>
                                  <td>
                                  <button onclick="(${userId})" type="button" class="btn btn-success"><i class="fa fa-user"></i></button>
                                  <button type="button" onclick="deleteWork(${laundryId})" class="btn btn-danger"><i class="fa fa-trash"></i></button>
                                  </td>
                                </tr>
                              </tbody>`
              $('#viewWorks').append(temp_html);
            }
          },
        });
      }

      // 세탁물 배송상황 변경하기
      function updateStatus(laundryId) {
        const status = $(`#select_status_${laundryId}`).val();
        $.ajax({
          type: 'PUT',
          url: `/api/owner/ownerWorkList/${laundryId}/edit`,
          data: { status },
          headers: {
          authorization: `Bearer ${localStorage.getItem('token')}`,
          },
          success: function (response) {
            customAlert(response['msg'], function () {
              window.location.reload();
            });
          },
        });
      }

      // 작업취소하기
      function deleteWork(laundryId) {
        $.ajax({
          type: 'DELETE',
          url: `/api/owner/ownerWorkList/${laundryId}/delete`,
          data: {},
          headers: {
          authorization: `Bearer ${localStorage.getItem('token')}`,
          },
          success: function (response) {
            customAlert(response['msg'], function () {
              window.location.reload();
            });
          },
        });
      }

      // 리뷰 조회
      function myReview_list() {
        $.ajax({
          type: 'GET',
          url: '/api/owner/ownerReview',
          data: {},
          headers: {
          authorization: `Bearer ${localStorage.getItem('token')}`,
          },
          success: function (response) {
            let rows = response['myReviews'];

            $('#viewMyReview').empty()

            for (let i = 0; i < rows.length; i++) {
              let laundryId = rows[i]['laundryId'];
              let userId = rows[i]['userId']
              let laundryName = rows[i]['laundryName'];
              let request = rows[i]['request'];
              let img = rows[i]['img'];
              let createdAt = rows[i]['createdAt'];
              let review = rows[i]['reveiw'];
              
              let temp_html = `<tbody>
                                <tr>
                                  <th scope="row">${laundryId}</th>
                                  <td>${laundryName}</td>
                                  <td>${request}</td>
                                  <td>${img}</td>
                                  <td>${createdAt}</td>
                                  <td>${review}</td>
                                </tr>
                              </tbody>`
              $('#viewMyReview').append(temp_html);
            }
          },
        });
      }

    </script>
  </body>
</html>
